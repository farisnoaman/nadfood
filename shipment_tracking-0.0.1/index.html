<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/icon-192.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام تتبع الشحنات</title>

  <!-- Dynamic PWA Manifest based on tenant/subdomain -->
  <script>
    (function () {
      // Extract subdomain or use query param for dev
      const hostname = window.location.hostname;
      let slug = 'balgaith'; // default

      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        // Development: use ?tenant= query param
        const params = new URLSearchParams(window.location.search);
        slug = params.get('tenant') || 'balgaith';
      } else {
        // Production: extract subdomain
        const parts = hostname.split('.');
        if (parts.length >= 3) {
          slug = parts[0];
        }
      }

      // Build dynamic manifest URL
      // Note: Update this URL after deploying the edge function
      const supabaseUrl = 'https://thenalkjfbmjyhvmhbki.supabase.co';
      const manifestUrl = supabaseUrl + '/functions/v1/serve-manifest?slug=' + encodeURIComponent(slug);

      // Create and append manifest link
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestUrl;
      document.head.appendChild(link);
    })();
  </script>

  <!-- Capture PWA install event early to ensure React doesn't miss it -->
  <script>
    window.deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPrompt = e;
    });
  </script>


  <!-- Arabic localization is now handled by the ArabicDatePicker component -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

    body {
      font-family: 'Cairo', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }



    /* Force Arabic text in date picker elements */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif;
    }

    /* Override browser date picker styling */
    .react-datepicker-wrapper,
    .react-datepicker__triangle,
    .react-datepicker__header,
    .react-datepicker__month-container,
    .react-datepicker__day-names,
    .react-datepicker__week {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif !important;
      direction: rtl !important;
    }

    .react-datepicker__header {
      background-color: #3b82f6 !important;
      color: white !important;
    }

    .react-datepicker__month-dropdown option,
    .react-datepicker__year-dropdown option,
    .react-datepicker__month-dropdown,
    .react-datepicker__year-dropdown {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif !important;
      text-align: right !important;
      direction: rtl !important;
    }

    .react-datepicker__day-name,
    .react-datepicker__day {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif !important;
    }

    .react-datepicker__current-month {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif !important;
      font-weight: 600 !important;
    }

    .react-datepicker__navigation {
      border-color: #3b82f6 !important;
    }

    .react-datepicker__navigation:hover {
      background-color: #3b82f6 !important;
      border-color: #2563eb !important;
    }

    /* Fallback styling for browsers that don't support Arabic date pickers */
    .arabic-date-picker-fallback {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif !important;
      direction: rtl !important;
    }

    .arabic-date-picker-fallback * {
      font-family: 'Cairo', 'Arial Unicode MS', sans-serif !important;
      text-align: right !important;
    }

    /* Mobile-specific optimizations */
    @media (max-width: 768px) {
      input[type="date"] {
        font-size: 16px;
        /* Prevent zoom on iOS */
      }

      .react-datepicker {
        font-size: 14px;
      }

      .react-datepicker__day {
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
      }
    }

    /* Dark mode support for date pickers */
    @media (prefers-color-scheme: dark) {
      .react-datepicker {
        background-color: #1f2937 !important;
        color: #f9fafb !important;
        border-color: #374151 !important;
      }

      .react-datepicker__header {
        background-color: #1d4ed8 !important;
        color: white !important;
      }

      .react-datepicker__day-name,
      .react-datepicker__day {
        color: #f9fafb !important;
      }

      .react-datepicker__day:hover {
        background-color: #374151 !important;
      }

      .react-datepicker__day--selected {
        background-color: #3b82f6 !important;
      }

      .react-datepicker__day--keyboard-selected {
        background-color: #1d4ed8 !important;
      }
    }
  </style>
  <!-- Clear service worker in development -->
  <script>
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      // Clear any existing service workers in development
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.unregister();
            console.log('Development: Unregistered service worker');
          });
        });

        // Clear caches
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
              caches.delete(cacheName);
              console.log('Development: Deleted cache:', cacheName);
            });
          });
        }
      }
    }
  </script>

  <script type="importmap">
{
  "imports": {
    "jspdf": "https://esm.sh/jspdf@2.5.1",
    "html2canvas": "https://esm.sh/html2canvas@1.4.1",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
  }
}
</script>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
</body>

</html>